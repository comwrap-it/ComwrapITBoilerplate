let t,e,l,r,n=Object.getPrototypeOf,o={isConnected:1},s={},f=n(o),i=n(n),u=(t,e,l,r)=>(t??(setTimeout(l,r),new Set)).add(e),h=(t,l,r)=>{let n=e;e=l;try{return t(r)}catch(t){return console.error(t),r}finally{e=n}},a=t=>t.filter(t=>t.t?.isConnected),d=t=>r=u(r,t,()=>{for(let t of r)t.l=a(t.l),t.o=a(t.o);r=null},1e3),_={get val(){return e?.i?.add(this),this.u},get oldVal(){return e?.i?.add(this),this.h},set val(l){if(e?._?.add(this),l!==this.u){this.u=l;let e=[...this.o=a(this.o)];for(let t of e)g(t.f,t.s,t.t),t.t=null;this.l.length?t=u(t,this,x):this.h=l}}},c=t=>({__proto__:_,u:t,h:t,l:[],o:[]}),w=(t,e)=>{let r={i:new Set,_:new Set},n={f:t},o=l;l=[];let s=h(t,r,e);s=(s??document).nodeType?s:new Text(s);for(let t of r.i)r._.has(t)||(d(t),t.l.push(n));for(let t of l)t.t=s;return l=o,n.t=s},g=(t,e=c(),r)=>{let n={i:new Set,_:new Set},s={f:t,s:e};s.t=r??l?.push(s)??o,e.val=h(t,n,e.u);for(let t of n.i)n._.has(t)||(d(t),t.o.push(s));return e},S=(t,...e)=>{for(let l of e.flat(1/0)){let e=n(l??0),r=e===_?w(()=>l.val):e===i?w(l):l;null!=r&&t.append(r)}return t},y=(t,e,...l)=>{let[r,...o]=n(l[0]??0)===f?l:[{},...l],u=t?document.createElementNS(t,e):document.createElement(e);for(let[t,l]of Object.entries(r)){let r=e=>e?Object.getOwnPropertyDescriptor(e,t)??r(n(e)):null,o=e+","+t,f=s[o]??(s[o]=r(n(u))?.set??0),h=t.startsWith("on")?(e,l)=>{let r=t.slice(2);u.removeEventListener(r,l),u.addEventListener(r,e)}:f?f.bind(u):u.setAttribute.bind(u,t),a=n(l??0);t.startsWith("on")||a===i&&(l=g(l),a=_),a===_?w(()=>(h(l.val,l.h),u)):h(l)}return S(u,...o)},b=t=>({get:(e,l)=>y.bind(null,t,l)}),m=new Proxy(t=>new Proxy(y,b(t)),b()),v=(t,e)=>e?e!==t&&t.replaceWith(e):t.remove(),x=()=>{let e=[...t].filter(t=>t.u!==t.h);t=null;for(let t of new Set(e.flatMap(t=>t.l=a(t.l))))v(t.t,w(t.f,t.t)),t.t=null;for(let t of e)t.h=t.u};export default{add:S,tags:m,state:c,derive:g,hydrate:(t,e)=>v(t,w(e,t))};